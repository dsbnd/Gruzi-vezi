-- 1. Создание пользовательских типов (ENUM) для ограничения вводимых данных
CREATE TYPE wagon_type_enum AS ENUM ('крытый', 'полувагон', 'платформа', 'цистерна', 'рефрижератор');
CREATE TYPE wagon_status_enum AS ENUM ('свободен', 'забронирован', 'в_пути', 'на_ремонте');
CREATE TYPE order_status_enum AS ENUM ('черновик', 'поиск_вагона', 'ожидает_оплаты', 'в_пути', 'доставлен');
CREATE TYPE service_name_enum AS ENUM ('страхование', 'сопровождение', 'терминальная_обработка');

-- 2. Таблица пользователей (Клиенты)
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    company_name VARCHAR(255) NOT NULL,
    inn VARCHAR(20) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 3. Таблица вагонов (Справочник подвижного состава)
CREATE TABLE wagons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    wagon_number VARCHAR(50) UNIQUE NOT NULL,
    wagon_type wagon_type_enum NOT NULL,
    max_weight_kg INTEGER NOT NULL,
    max_volume_m3 INTEGER NOT NULL,
    current_station VARCHAR(255) NOT NULL,
    status wagon_status_enum DEFAULT 'свободен'
);

-- 4. Таблица заявок на перевозку
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    departure_station VARCHAR(255) NOT NULL,
    destination_station VARCHAR(255) NOT NULL,
    -- wagon_id может быть NULL, пока вагон не найден
    wagon_id UUID REFERENCES wagons(id) ON DELETE SET NULL,
    status order_status_enum DEFAULT 'черновик',
    total_price DECIMAL(10, 2),
    carbon_footprint_kg DECIMAL(10, 2),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 5. Таблица характеристик груза (Связь 1 к 1 с заявкой)
CREATE TABLE cargo (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    -- UNIQUE гарантирует, что у одной заявки только один груз
    order_id UUID UNIQUE NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    cargo_type VARCHAR(255) NOT NULL,
    weight_kg INTEGER NOT NULL,
    volume_m3 INTEGER NOT NULL,
    packaging_type VARCHAR(100) NOT NULL
);

-- 6. Таблица дополнительных услуг (Связь 1 ко многим с заявкой)
CREATE TABLE order_services (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    service_name service_name_enum NOT NULL,
    price DECIMAL(10, 2) NOT NULL
);

-- Таблица тарифов
CREATE TABLE tariffs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    cargo_type VARCHAR(255) NOT NULL,
    wagon_type VARCHAR(255) NOT NULL,
    base_rate DECIMAL(10,2) NOT NULL,
    coefficient DECIMAL(5,2) DEFAULT 1.0,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(cargo_type, wagon_type)
);
-- изменения тут начинаются!!
-- Создаем новую таблицу с корпоративными реквизитами
CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id UUID NOT NULL,
    payment_id VARCHAR(255) UNIQUE,
    amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(50) NOT NULL,
    payment_method VARCHAR(100),

    -- Корпоративные реквизиты плательщика
    company_name VARCHAR(255),
    inn VARCHAR(12),
    kpp VARCHAR(9),

    -- Банковские реквизиты плательщика
    bik VARCHAR(9),
    account_number VARCHAR(20),
    correspondent_account VARCHAR(20),
    bank_name VARCHAR(255),

    -- Детали платежа
    payment_purpose TEXT,
    payment_document VARCHAR(50),
    payment_date TIMESTAMP WITH TIME ZONE,

    -- Системные поля
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    paid_at TIMESTAMP WITH TIME ZONE,
    error_message TEXT,

    -- Внешний ключ
    CONSTRAINT fk_payments_order FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
);

-- Индексы для быстрого поиска
CREATE INDEX idx_payments_order_id ON payments(order_id);
CREATE INDEX idx_payments_payment_id ON payments(payment_id);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_inn ON payments(inn);
CREATE INDEX idx_payments_inn_status ON payments(inn, status);
CREATE INDEX idx_payments_document ON payments(payment_document);
CREATE INDEX idx_payments_created_at ON payments(created_at);

-- Комментарии к таблице
COMMENT ON TABLE payments IS 'Платежи с корпоративными реквизитами для грузовых перевозок';
COMMENT ON COLUMN payments.inn IS 'ИНН плательщика (10 или 12 цифр)';
COMMENT ON COLUMN payments.kpp IS 'КПП плательщика (9 цифр для юрлиц)';
COMMENT ON COLUMN payments.bik IS 'БИК банка плательщика';
COMMENT ON COLUMN payments.account_number IS 'Расчетный счет плательщика';
COMMENT ON COLUMN payments.payment_document IS 'Номер платежного документа (платежное поручение)';
-- тут заканчиваются

-- Индексы для tariffs
CREATE INDEX idx_tariffs_cargo_type ON tariffs(cargo_type);
CREATE INDEX idx_tariffs_wagon_type ON tariffs(wagon_type);
-- начинаются тут обновления
-- Таблица банковских счетов компаний
CREATE TABLE company_accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    inn VARCHAR(12) UNIQUE NOT NULL,              -- ИНН компании (уникальный)
    company_name VARCHAR(255) NOT NULL,            -- Название компании
    account_number VARCHAR(20) UNIQUE NOT NULL,    -- Номер счета
    balance DECIMAL(15,2) DEFAULT 0.00,            -- Текущий баланс
    bik VARCHAR(9) NOT NULL,                       -- БИК банка
    bank_name VARCHAR(255) NOT NULL,                -- Название банка
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Счет РЖД (один общий для всех)
INSERT INTO company_accounts (inn, company_name, account_number, balance, bik, bank_name) VALUES
('7708503727', 'ОАО РЖД (Грузовые перевозки)', '40702810900000000001', 10000000.00, '044525225', 'ПАО СБЕРБАНК');

-- Индекс для быстрого поиска по ИНН
CREATE INDEX idx_company_accounts_inn ON company_accounts(inn);

-- Функция для создания счета при добавлении пользователя
CREATE OR REPLACE FUNCTION create_account_for_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO company_accounts (inn, company_name, account_number, balance, bik, bank_name)
    VALUES (
        NEW.inn,
        NEW.company_name,
        '40702810' || substring(NEW.inn from 1 for 8) || floor(random() * 10000)::int,
        500000.00,  -- Стартовый баланс 500к
        '044525225',
        'ПАО СБЕРБАНК'
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Триггер на добавление пользователя
CREATE TRIGGER after_user_insert
    AFTER INSERT ON users
    FOR EACH ROW
    EXECUTE FUNCTION create_account_for_new_user();
-- тут заканчиваются

-- Очищаем таблицы перед вставкой (на случай, если будете запускать скрипт повторно для сброса данных)
TRUNCATE TABLE order_services, cargo, orders, wagons, users, payments, tariffs CASCADE;

-- 1. Добавляем тестовых клиентов
INSERT INTO users (id, email, password_hash, company_name, inn) VALUES
('a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 'logistics@vector.ru', 'hashed_pwd_1', 'ООО Вектор', '7701234567'),
('b0eebc99-9c0b-4ef8-bb6d-6bb9bd380a22', 'supply@romashka.ru', 'hashed_pwd_2', 'ЗАО Ромашка', '7709876543');

-- 2. Добавляем вагоны (Справочник для алгоритма подбора)
INSERT INTO wagons (id, wagon_number, wagon_type, max_weight_kg, max_volume_m3, current_station, status) VALUES
('11111111-1111-1111-1111-111111111111', '12345678', 'крытый', 68000, 120, 'Москва-Товарная', 'свободен'),
('22222222-2222-2222-2222-222222222222', '87654321', 'полувагон', 71000, 85, 'Москва-Товарная', 'свободен'),
('33333333-3333-3333-3333-333333333333', '11223344', 'крытый', 68000, 120, 'Казань', 'свободен'),
('44444444-4444-4444-4444-444444444444', '55667788', 'платформа', 72000, 0, 'Санкт-Петербург', 'забронирован');

-- 3. Добавляем заявки на перевозку
-- Заявка 1: Ищет вагон. Груз поедет из Москвы.
INSERT INTO orders (id, user_id, departure_station, destination_station, status) VALUES
('c0eebc99-9c0b-4ef8-bb6d-6bb9bd380a33', 'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11', 'Москва-Товарная', 'Екатеринбург', 'поиск_вагона');

-- Заявка 2: Вагон уже найден (привязан wagon_id = 4444...), рассчитана цена и экологический след.
INSERT INTO orders (id, user_id, departure_station, destination_station, wagon_id, status, total_price, carbon_footprint_kg) VALUES
('d0eebc99-9c0b-4ef8-bb6d-6bb9bd380a44', 'b0eebc99-9c0b-4ef8-bb6d-6bb9bd380a22', 'Санкт-Петербург', 'Новосибирск', '44444444-4444-4444-4444-444444444444', 'ожидает_оплаты', 150000.00, 450.50);

-- 4. Добавляем характеристики грузов к заявкам
-- Для Заявки 1: Вес 60т, объем 100м3.
INSERT INTO cargo (order_id, cargo_type, weight_kg, volume_m3, packaging_type) VALUES
('c0eebc99-9c0b-4ef8-bb6d-6bb9bd380a33', 'Электроника', 60000, 100, 'Паллеты'),
('d0eebc99-9c0b-4ef8-bb6d-6bb9bd380a44', 'Трубы стальные', 70000, 40, 'Без упаковки');

-- 5. Добавляем дополнительные услуги
INSERT INTO order_services (order_id, service_name, price) VALUES
('c0eebc99-9c0b-4ef8-bb6d-6bb9bd380a33', 'страхование', 5000.00),
('d0eebc99-9c0b-4ef8-bb6d-6bb9bd380a44', 'сопровождение', 15000.00),
('d0eebc99-9c0b-4ef8-bb6d-6bb9bd380a44', 'терминальная_обработка', 8000.00);

-- 1. Тестовые тарифы
INSERT INTO tariffs (id, cargo_type, wagon_type, base_rate, coefficient, description) VALUES
(gen_random_uuid(), 'Электроника', 'крытый', 15.50, 1.2, 'Тариф для электроники в крытых вагонах'),
(gen_random_uuid(), 'Электроника', 'полувагон', 14.00, 1.1, 'Тариф для электроники в полувагонах'),
(gen_random_uuid(), 'Уголь', 'полувагон', 8.50, 1.0, 'Тариф для угля'),
(gen_random_uuid(), 'Нефть', 'цистерна', 12.00, 1.3, 'Тариф для нефтепродуктов'),
(gen_random_uuid(), 'Металл', 'платформа', 11.50, 1.1, 'Тариф для металлопроката'),
(gen_random_uuid(), 'Лес', 'полувагон', 9.00, 1.0, 'Тариф для леса'),
(gen_random_uuid(), 'Оборудование', 'крытый', 18.00, 1.4, 'Тариф для оборудования'),
(gen_random_uuid(), 'Зерно', 'крытый', 7.50, 0.9, 'Тариф для зерна'),
(gen_random_uuid(), 'Химия', 'цистерна', 13.50, 1.5, 'Тариф для химических грузов'),
(gen_random_uuid(), 'Контейнеры', 'платформа', 16.00, 1.2, 'Тариф для контейнеров');


INSERT INTO payments (
    id, order_id, payment_id, amount, status, payment_method,
    company_name, inn, kpp, bik, account_number, bank_name,
    payment_purpose, payment_document, created_at
) VALUES
(
    gen_random_uuid(),
    'd0eebc99-9c0b-4ef8-bb6d-6bb9bd380a44',
    'pay_123456789',
    150000.00,
    'SUCCEEDED',
    'BANK_TRANSFER',
    'ООО Ромашка',
    '7701234567',
    '770101001',
    '044525225',
    '40702810123450123456',
    'ПАО СБЕРБАНК',
    'Оплата грузовой перевозки по договору №РЖД-2026-123',
    'РЖД-1712345678-123',
    '2026-02-27 10:00:00+03'
),
(
    gen_random_uuid(),
    'c0eebc99-9c0b-4ef8-bb6d-6bb9bd380a33',
    'pay_987654321',
    75000.00,
    'PENDING',
    'BANK_TRANSFER',
    'ООО Вектор',
    '7709876543',
    '770901001',
    '044525111',
    '40702810567890123456',
    'АО АЛЬФА-БАНК',
    'Предоплата за перевозку оборудования',
    'РЖД-1712345678-124',
    '2026-02-27 11:30:00+03'
);